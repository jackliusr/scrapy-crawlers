from scrapy.selector import Selector
from scrapy.linkextractors import LinkExtractor
from scrapy.spiders import CrawlSpider, Rule
from crawlers.items import JdItem
from scrapy.http import TextResponse,FormRequest,Request
import json


class JdGameSpider(CrawlSpider):
    name = 'jd-game'
    allowed_domains = ['jd.com','p.3.cn']
    
    #start_urls = ['http://www.jd.com/']

    start_urls = ['http://list.jd.com/4938-9394-4835-0-61652-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-142275-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61624-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61665-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61678-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-88236-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-148838-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-201602-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-139396-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-140945-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61654-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-180970-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-192918-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61633-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-332979-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-477512-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-332980-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-332981-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61614-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61615-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-78925-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-140460-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-195835-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-477513-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61619-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61620-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61621-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-140943-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-332984-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-406455-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-78926-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-368674-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-368722-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-477516-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-477517-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-477518-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-368700-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-368712-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-477519-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-332976-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61636-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-78924-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-281597-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-332974-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-332988-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-332990-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-357067-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-368711-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-368719-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61639-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-140466-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-332991-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-332992-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-332993-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61642-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-80210-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-281594-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-332994-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-332995-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-332996-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-368679-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61648-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61649-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-78913-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-88239-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-333000-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-333002-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-333004-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-333005-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-333006-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-368691-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-333007-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-368699-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-368687-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-368708-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61655-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-88245-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-140996-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-192915-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-195834-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-332973-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-333008-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-357109-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-368675-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-368695-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-368707-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-477511-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61659-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61660-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-186632-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-333009-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61662-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61664-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61666-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61667-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-333010-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-357094-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-368678-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-368698-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-368713-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-142276-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-142279-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-333011-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-333012-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61679-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61682-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61683-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-144240-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-191488-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-332971-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-332972-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-333013-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-333014-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-333015-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-333394-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61684-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-142280-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-195372-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-332977-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-333016-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-357089-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-357129-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-368692-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-526720-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61694-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-80208-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-195844-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-332968-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-333019-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-333020-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-333021-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-333022-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-61700-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-78897-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-78917-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-140934-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-177355-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-177360-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-333026-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-357081-0-0-0-0-0-1-1-1-1-1-72-4137-0.html',
          'http://list.jd.com/4938-9394-4835-0-368721-0-0-0-0-0-1-1-1-1-1-72-4137-0.html']

    rules = (
    Rule(LinkExtractor(allow=r'item\.jd\.com/'), callback='parse_item', follow=False),
    )

    def parse_item(self, response):      
        sel = Selector(response)
        i = JdItem()
        i['name'] = sel.xpath("//div[@id='name']/h1/text()").extract()
        i['description'] = sel.xpath("//div[@id='product-detail-1']/ul").extract()
        i['category'] = sel.xpath("//div[@class='breadcrumb']/span/a/text()").extract()[1]
        #i['price'] = sel.xpath("//strong[@id='jd-price']/text()").extract()
        i['image_urls'] = sel.xpath("//div[@id='spec-n1']/img/@src").extract()
        url = response.url
        itemid = url[url.rindex('/')+1:-5]   
        request=  Request("http://p.3.cn/prices/get?skuid=J_%s&type=1" % itemid, callback=self.parse_price)
        request.meta['item'] = i
        yield request
        
    def parse_price(self, response):
      i = response.meta['item']
      jsonData = json.loads(response.body)
      #i['itemid'] = jsonData[0]['id']
      i['price'] = jsonData[0]['p']
      return i
